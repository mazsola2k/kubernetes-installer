---
# Windows 11 GPU Passthrough Setup
# Detects current host state, shows all required changes as a dry-run, asks for
# confirmation, then applies: IOMMU in GRUB, vfio-pci modprobe/modules-load,
# initramfs + GRUB rebuild, and KubeVirt PermittedHostDevices registration.
#
# A HOST REBOOT is required after apply before the GPU is available to the VM.
#
# Usage — initial host setup (one-time, reboot required after):
#   ansible-playbook windows-client-controller.yaml -e action=gpu-setup
#   ansible-playbook windows-client-controller.yaml -e action=gpu-setup -e gpu_confirm=yes
#
# Usage — claim GPU for Windows VM (nvidia → vfio-pci, no reboot):
#   ansible-playbook windows-client-controller.yaml -e action=gpu-claim
#
# Usage — release GPU back to Fedora desktop/AI (vfio-pci → nvidia, no reboot):
#   ansible-playbook windows-client-controller.yaml -e action=gpu-release
#
# Variables (all have defaults):
#   gpu_pci_slot         PCI address of GPU VGA function   (default: 0000:03:00.0)
#   gpu_audio_slot       PCI address of GPU audio function  (default: 0000:03:00.1)
#   gpu_vendor_id        PCI vendor:device for VGA          (default: 10de:2204)
#   gpu_audio_id         PCI vendor:device for audio        (default: 10de:1aef)
#   gpu_resource_name    KubeVirt resource name             (default: nvidia.com/RTX_3090)
#   gpu_confirm          Skip interactive prompt in gpu-setup (default: no)
#   vm_name              VM to stop/start during claim/release (default: win11client)

# ============================================================
# Phase 1 — Gather current host state
# ============================================================
- name: Detect CPU vendor
  ansible.builtin.shell: grep -m1 vendor_id /proc/cpuinfo | awk '{print $3}'
  register: cpu_vendor
  changed_when: false

- name: Set per-host variables
  ansible.builtin.set_fact:
    # AMD: IOMMU auto-enables when BIOS presents IVRS ACPI table — no amd_iommu= needed.
    #      (amd_iommu=on is NOT a valid value; force_enable is only for buggy BIOS with IVRS)
    # Intel: intel_iommu=on is required to activate VT-d.
    # Both: iommu=pt (passthrough mode) is always added separately.
    iommu_param: "{{ 'intel_iommu=on' if 'Intel' in cpu_vendor.stdout else '' }}"
    gpu_pci_slot: "{{ gpu_pci_slot | default('0000:03:00.0') }}"
    gpu_audio_slot: "{{ gpu_audio_slot | default('0000:03:00.1') }}"
    gpu_vendor_id: "{{ gpu_vendor_id | default('10de:2204') }}"
    gpu_audio_id: "{{ gpu_audio_id | default('10de:1aef') }}"
    gpu_resource_name: "{{ gpu_resource_name | default('nvidia.com/RTX_3090') }}"

- name: Read current GRUB cmdline value (from active BLS loader entry)
  ansible.builtin.shell: |
    # On Fedora with BLS, /etc/default/grub is only a template — the BLS loader
    # entry for the running kernel is the real boot source. Check that directly.
    kernel_ver=$(uname -r)
    entry=$(ls /boot/loader/entries/*-${kernel_ver}.conf 2>/dev/null | head -1)
    if [ -n "$entry" ]; then
      grep '^options ' "$entry" | sed 's/^options //'
    else
      # Fallback for non-BLS systems
      grep '^GRUB_CMDLINE_LINUX=' /etc/default/grub | sed 's/GRUB_CMDLINE_LINUX=//;s/"//g'
    fi
  register: current_grub_cmdline
  changed_when: false

- name: Check BIOS IOMMU enablement (IVRS table for AMD, DMAR table for Intel)
  ansible.builtin.shell: |
    if [ -f /sys/firmware/acpi/tables/IVRS ]; then
      echo "IVRS"
    elif [ -f /sys/firmware/acpi/tables/DMAR ]; then
      echo "DMAR"
    else
      echo "absent"
    fi
  register: bios_iommu_table
  changed_when: false

- name: Set BIOS IOMMU status
  ansible.builtin.set_fact:
    bios_iommu_enabled: "{{ bios_iommu_table.stdout != 'absent' }}"

- name: Check IOMMU already present in GRUB
  ansible.builtin.set_fact:
    # iommu=pt must always be present.
    # For Intel, intel_iommu=on must also be present.
    # For AMD, no amd_iommu= is needed — only iommu=pt.
    iommu_in_grub: >-
      {{
        'iommu=pt' in current_grub_cmdline.stdout and
        (iommu_param == '' or iommu_param in current_grub_cmdline.stdout)
      }}
    # Detect stale amd_iommu= params left from prior runs (need removal)
    stale_amd_iommu_in_grub: >-
      {{
        'Intel' not in cpu_vendor.stdout and
        'amd_iommu=' in current_grub_cmdline.stdout
      }}

- name: Check vfio-pci modprobe config
  ansible.builtin.stat:
    path: /etc/modprobe.d/vfio-pci.conf
  register: vfio_modprobe_stat

- name: Read existing vfio-pci modprobe config
  ansible.builtin.slurp:
    src: /etc/modprobe.d/vfio-pci.conf
  register: vfio_modprobe_content
  when: vfio_modprobe_stat.stat.exists

- name: Check dracut pre-udev hook exists (slot-specific binding)
  ansible.builtin.stat:
    path: /usr/lib/dracut/hooks/pre-udev/80-vfio-pci-override.sh
  register: vfio_dracut_hook_stat

- name: Check dracut.conf.d vfio config exists
  ansible.builtin.stat:
    path: /etc/dracut.conf.d/vfio-pci.conf
  register: vfio_dracut_conf_stat

- name: Detect whether vfio modprobe softdeps are configured
  ansible.builtin.set_fact:
    # Check for the unique marker we write into the correct config.
    # We check for 'softdep nvidia pre' (present in correct config) and
    # NOT 'DUAL-GPU-SAFE-NOIDS' marker absence to indicate old id-based config.
    # Simpler: just check softdep present + unique comment marker.
    vfio_modprobe_ok: >-
      {{
        vfio_modprobe_stat.stat.exists and
        'softdep nvidia pre' in (vfio_modprobe_content.content | default('') | b64decode) and
        'DUAL-GPU-SAFE' in (vfio_modprobe_content.content | default('') | b64decode)
      }}

- name: Check vfio modules-load config
  ansible.builtin.stat:
    path: /etc/modules-load.d/vfio-pci.conf
  register: vfio_modules_stat

- name: Get current GPU VGA driver
  ansible.builtin.shell: |
    drv=$(readlink /sys/bus/pci/devices/{{ gpu_pci_slot }}/driver 2>/dev/null)
    if [ -n "$drv" ]; then basename "$drv"; else echo "none"; fi
  register: gpu_current_driver
  changed_when: false

- name: Get current GPU Audio driver
  ansible.builtin.shell: |
    drv=$(readlink /sys/bus/pci/devices/{{ gpu_audio_slot }}/driver 2>/dev/null)
    if [ -n "$drv" ]; then basename "$drv"; else echo "none"; fi
  register: gpu_audio_current_driver
  changed_when: false

- name: Check KubeVirt PermittedHostDevices
  ansible.builtin.shell: |
    kubectl get kubevirt kubevirt -n kubevirt \
      -o jsonpath='{.spec.configuration.permittedHostDevices}' 2>/dev/null || echo ""
  register: kubevirt_permitted_devices
  changed_when: false

- name: Compute what needs to change
  ansible.builtin.set_fact:
    change_grub: "{{ not iommu_in_grub or stale_amd_iommu_in_grub }}"
    change_vfio_modprobe: "{{ not vfio_modprobe_ok }}"
    change_vfio_modules: "{{ not vfio_modules_stat.stat.exists }}"
    change_vfio_dracut_hook: "{{ not vfio_dracut_hook_stat.stat.exists }}"
    change_vfio_dracut_conf: "{{ not vfio_dracut_conf_stat.stat.exists }}"
    change_kubevirt: "{{ gpu_vendor_id not in kubevirt_permitted_devices.stdout }}"
    reboot_required: "{{ not iommu_in_grub or not vfio_modprobe_ok or not vfio_modules_stat.stat.exists or not vfio_dracut_hook_stat.stat.exists }}"
    gpu_vendor_id_space: "{{ gpu_vendor_id | replace(':', ' ') }}"
    gpu_audio_id_space: "{{ gpu_audio_id | replace(':', ' ') }}"

# ============================================================
# Phase 2 — Dry-run summary  (gpu-setup only)
# ============================================================
- name: Show current state and planned changes
  when: gpu_action | default('setup') == 'setup'
  ansible.builtin.debug:
    msg:
      - "╔══════════════════════════════════════════════════════════════╗"
      - "║          GPU PASSTHROUGH SETUP — PLANNED CHANGES             ║"
      - "╚══════════════════════════════════════════════════════════════╝"
      - ""
      - "  Host GPU : NVIDIA GeForce RTX 3090 ({{ gpu_pci_slot }})"
      - "  PCI IDs  : VGA={{ gpu_vendor_id }}   Audio={{ gpu_audio_id }}"
      - "  CPU      : {{ cpu_vendor.stdout }} → kernel params: {{ (iommu_param ~ ' ') if iommu_param else '' }}iommu=pt"
      - "  BIOS IOMMU : {{ bios_iommu_table.stdout if bios_iommu_enabled else 'NOT DETECTED — enable IOMMU in BIOS! (AMD: CBS → NBIO → IOMMU)' }}"
      - ""
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "CURRENT STATE"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "  GRUB cmdline    : {{ current_grub_cmdline.stdout }}"
      - "  IOMMU in GRUB   : {{ 'YES' if iommu_in_grub else 'NO' }}"
      - "  vfio modprobe   : {{ 'OK (no ids=)' if vfio_modprobe_ok else 'MISSING or has ids=' }}"
      - "  dracut hook     : {{ 'exists' if vfio_dracut_hook_stat.stat.exists else 'MISSING' }}"
      - "  dracut.conf.d   : {{ 'exists' if vfio_dracut_conf_stat.stat.exists else 'MISSING' }}"
      - "  vfio modules-ld : {{ 'exists' if vfio_modules_stat.stat.exists else 'MISSING' }}"
      - "  GPU VGA driver  : {{ gpu_current_driver.stdout }}"
      - "  GPU Audio driver: {{ gpu_audio_current_driver.stdout }}"
      - "  KubeVirt GPU    : {{ 'configured' if not change_kubevirt else 'NOT configured' }}"
      - ""
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "CHANGES TO APPLY"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "{% if change_grub %}  [1] grubby --update-kernel=ALL --args='{{ (iommu_param ~ ' ') if iommu_param else '' }}iommu=pt'{% if stale_amd_iommu_in_grub %}  + remove stale amd_iommu= params{% endif %}{% else %}  [1] GRUB BLS entries — no change needed{% endif %}"
      - "{% if change_vfio_modprobe %}  [2] CREATE /etc/modprobe.d/vfio-pci.conf: softdep nvidia pre: vfio-pci (NO ids= to protect 2nd GPU){% else %}  [2] /etc/modprobe.d/vfio-pci.conf — no change needed{% endif %}"
      - "{% if change_vfio_dracut_hook %}  [3] CREATE /usr/lib/dracut/hooks/pre-udev/80-vfio-pci-override.sh (slot-specific: {{ gpu_pci_slot }} only){% else %}  [3] dracut pre-udev hook — no change needed{% endif %}"
      - "{% if change_vfio_dracut_conf %}  [4] CREATE /etc/dracut.conf.d/vfio-pci.conf (include vfio modules + hook){% else %}  [4] /etc/dracut.conf.d/vfio-pci.conf — no change needed{% endif %}"
      - "{% if change_vfio_modules %}  [5] CREATE /etc/modules-load.d/vfio-pci.conf: vfio vfio_iommu_type1 vfio-pci{% else %}  [5] /etc/modules-load.d/vfio-pci.conf — no change needed{% endif %}"
      - "{% if reboot_required %}  [6] dracut --force  (rebuild initramfs){% else %}  [6] dracut — no rebuild needed{% endif %}"
      - "{% if change_kubevirt %}  [7] kubectl patch kubevirt — add PermittedHostDevices ({{ gpu_vendor_id }}){% else %}  [7] KubeVirt PermittedHostDevices — no change needed{% endif %}"
      - ""
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "  DUAL-GPU SAFE: Only {{ gpu_pci_slot }} targeted. GPU at 0a:00.0 stays on nvidia for Fedora desktop."
      - "{% if not bios_iommu_enabled %}  ⚠ BIOS IOMMU NOT ENABLED — GPU passthrough WILL NOT WORK until you enable IOMMU in BIOS!{% endif %}"
      - "{% if not bios_iommu_enabled %}    → Reboot into BIOS (Del/F2): AMD CBS → NBIO → IOMMU → Enabled  (Intel: VT-d){% endif %}"
      - "{% if reboot_required %}  *** HOST REBOOT REQUIRED after apply ***{% elif not bios_iommu_enabled %}  *** BIOS CHANGE + REBOOT REQUIRED ***{% else %}  No reboot required — IOMMU and vfio-pci already active{% endif %}"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

- name: Nothing to do — already fully configured
  ansible.builtin.debug:
    msg: >-
      GPU passthrough host config is complete — nothing to apply.
      {{ '' if bios_iommu_enabled else
         '⚠ BUT: BIOS IOMMU is NOT enabled! '
         'AMD boards: BIOS → AMD CBS → NBIO → IOMMU → Enabled. Intel: enable VT-d. '
         'After reboot verify: sudo dmesg | grep AMD-Vi && ls /sys/kernel/iommu_groups/ | wc -l' }}
  when:
    - gpu_action | default('setup') == 'setup'
    - not change_grub
    - not change_vfio_modprobe
    - not change_vfio_modules
    - not change_vfio_dracut_hook
    - not change_vfio_dracut_conf
    - not change_kubevirt

# ============================================================
# Phase 3 — Confirmation prompt
# ============================================================
- name: Ask user to confirm
  ansible.builtin.pause:
    prompt: |

      Review the planned changes above.
      Type  YES  to proceed and apply all changes, or press Ctrl+C to abort
  register: confirmation_result
  when:
    - gpu_action | default('setup') == 'setup'
    - gpu_confirm | default('no') | lower != 'yes'
    - change_grub or change_vfio_modprobe or change_vfio_modules or change_vfio_dracut_hook or change_vfio_dracut_conf or change_kubevirt

- name: Abort if user did not confirm
  ansible.builtin.fail:
    msg: "Aborted — user did not type YES. No changes were made."
  when:
    - gpu_action | default('setup') == 'setup'
    - gpu_confirm | default('no') | lower != 'yes'
    - change_grub or change_vfio_modprobe or change_vfio_modules or change_vfio_dracut_hook or change_vfio_dracut_conf or change_kubevirt
    - confirmation_result.user_input | default('') | upper != 'YES'

# ============================================================
# Phase 4 — Apply host-level changes  (gpu-setup only)
# ============================================================
- name: Apply host IOMMU / vfio configuration
  when: (change_grub or change_vfio_modprobe or change_vfio_modules or change_vfio_dracut_hook or change_vfio_dracut_conf) and (gpu_action | default('setup') == 'setup')
  block:
    - name: Remove stale amd_iommu parameters from BLS entries (AMD only)
      # amd_iommu=on was never valid; force_enable only for buggy BIOS with IVRS.
      # AMD IOMMU auto-enables from BIOS IVRS — no amd_iommu= param needed at all.
      ansible.builtin.shell: >-
        grubby --update-kernel=ALL
        --remove-args='amd_iommu=on amd_iommu=force_enable amd_iommu=fullflush amd_iommu=force_isolation'
      changed_when: true
      when: stale_amd_iommu_in_grub | bool

    - name: Add IOMMU parameters to all kernel entries (grubby — BLS-aware)
      # grubby directly updates /boot/loader/entries/*.conf — the real boot source.
      # No grub2-mkconfig needed. Works correctly on Fedora with Secure Boot too.
      # AMD: only iommu=pt (IOMMU auto-enables from BIOS IVRS table)
      # Intel: intel_iommu=on iommu=pt
      ansible.builtin.shell: "grubby --update-kernel=ALL --args='{{ (iommu_param ~ ' ') if iommu_param else '' }}iommu=pt'"
      changed_when: true
      when: change_grub

    - name: Write vfio-pci modprobe configuration (softdeps only — no ids=)
      ansible.builtin.copy:
        dest: /etc/modprobe.d/vfio-pci.conf
        mode: '0644'
        content: |
          # DUAL-GPU-SAFE: vfio-pci GPU passthrough via slot-specific dracut hook
          # Target: NVIDIA GeForce RTX 3090 @ {{ gpu_pci_slot }} ONLY
          # The second RTX 3090 at 0a:00.0 is intentionally left for Fedora desktop.
          # Slot-specific binding is handled by the dracut pre-udev hook.

          # Ensure vfio-pci loads before nvidia so driver_override takes effect
          softdep nvidia pre: vfio-pci
          softdep nvidia_drm pre: vfio-pci
          softdep nvidia_modeset pre: vfio-pci
          softdep nvidia_uvm pre: vfio-pci
      when: change_vfio_modprobe

    - name: Create dracut pre-udev hook for slot-specific GPU binding
      ansible.builtin.copy:
        dest: /usr/lib/dracut/hooks/pre-udev/80-vfio-pci-override.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # Bind ONLY {{ gpu_pci_slot }} + {{ gpu_audio_slot }} to vfio-pci.
          # GPU at 0a:00.0 is left for the Fedora host desktop / AI workloads.
          for DEV in {{ gpu_pci_slot }} {{ gpu_audio_slot }}; do
              echo "vfio-pci" > /sys/bus/pci/devices/${DEV}/driver_override
          done
          modprobe -i vfio-pci
      when: change_vfio_dracut_hook

    - name: Create dracut.conf.d to include vfio modules and hook in initramfs
      ansible.builtin.copy:
        dest: /etc/dracut.conf.d/vfio-pci.conf
        mode: '0644'
        content: |
          # Include vfio-pci modules and the slot-override hook in initramfs
          add_drivers+=" vfio vfio_iommu_type1 vfio-pci "
          install_items+=" /usr/lib/dracut/hooks/pre-udev/80-vfio-pci-override.sh "
      when: change_vfio_dracut_conf

    - name: Write vfio modules-load configuration
      ansible.builtin.copy:
        dest: /etc/modules-load.d/vfio-pci.conf
        mode: '0644'
        content: |
          vfio
          vfio_iommu_type1
          vfio-pci
      when: change_vfio_modules

    - name: Rebuild initramfs (dracut --force)
      ansible.builtin.shell: dracut --force
      changed_when: true
      when: change_grub or change_vfio_modprobe or change_vfio_dracut_hook or change_vfio_dracut_conf or change_vfio_modules

    # grubby (used above) updates BLS entries directly — no grub2-mkconfig needed.

# ============================================================
# Phase 5 — Configure KubeVirt PermittedHostDevices  (gpu-setup only)
# ============================================================
- name: Patch KubeVirt to allow GPU passthrough
  when: change_kubevirt and (gpu_action | default('setup') == 'setup')
  block:
    - name: Check if pciHostDevices list already exists in KubeVirt
      ansible.builtin.shell: |
        kubectl get kubevirt kubevirt -n kubevirt \
          -o jsonpath='{.spec.configuration.permittedHostDevices.pciHostDevices}' 2>/dev/null || echo ""
      register: existing_pci_devices
      changed_when: false

    - name: Patch KubeVirt — fresh permittedHostDevices (none existed)
      ansible.builtin.shell: |
        kubectl patch kubevirt kubevirt -n kubevirt --type=merge -p '{
          "spec": {
            "configuration": {
              "permittedHostDevices": {
                "pciHostDevices": [
                  {
                    "pciVendorSelector": "{{ gpu_vendor_id }}",
                    "resourceName": "{{ gpu_resource_name }}"
                  }
                ]
              }
            }
          }
        }'
      when: existing_pci_devices.stdout | trim | length == 0
      changed_when: true

    - name: Patch KubeVirt — append to existing pciHostDevices
      ansible.builtin.shell: |
        kubectl patch kubevirt kubevirt -n kubevirt --type=json -p '[
          {
            "op": "add",
            "path": "/spec/configuration/permittedHostDevices/pciHostDevices/-",
            "value": {
              "pciVendorSelector": "{{ gpu_vendor_id }}",
              "resourceName": "{{ gpu_resource_name }}"
            }
          }
        ]'
      when: existing_pci_devices.stdout | trim | length > 0
      changed_when: true

    - name: Label Kubernetes node with GPU resource
      ansible.builtin.shell: |
        NODE=$(kubectl get nodes -o jsonpath='{.items[0].metadata.name}')
        kubectl label node "$NODE" nvidia.com/gpu=present --overwrite
      changed_when: true

# ============================================================
# Phase 6 — Summary  (gpu-setup only)
# ============================================================
- name: Display result summary (header + status)
  when: gpu_action | default('setup') == 'setup'
  ansible.builtin.debug:
    msg:
      - "╔══════════════════════════════════════════════════════════════╗"
      - "║              GPU PASSTHROUGH SETUP — DONE                    ║"
      - "╚══════════════════════════════════════════════════════════════╝"
      - ""
      - "  GRUB updated       : {{ 'APPLIED' if change_grub else 'skipped (already set)' }}"
      - "  vfio-pci modprobe  : {{ 'APPLIED' if change_vfio_modprobe else 'skipped (already set)' }}"
      - "  vfio modules-load  : {{ 'APPLIED' if change_vfio_modules else 'skipped (already set)' }}"
      - "  KubeVirt GPU       : {{ 'APPLIED' if change_kubevirt else 'skipped (already set)' }}"
      - "  Initramfs rebuilt  : {{ 'YES' if (change_grub or change_vfio_modprobe or change_vfio_modules) else 'no (not needed)' }}"

- name: Display result summary (reboot required)
  when:
    - gpu_action | default('setup') == 'setup'
    - reboot_required | bool
  ansible.builtin.debug:
    msg:
      - "  !! REBOOT NOW to activate IOMMU + vfio-pci binding:"
      - "       sudo reboot"
      - ""
      - "{% if not bios_iommu_enabled %}  ⚠ CRITICAL: BIOS IOMMU is NOT enabled! Before rebooting:{% endif %}"
      - "{% if not bios_iommu_enabled %}    1. Enter BIOS firmware setup (Del/F2 at POST){% endif %}"
      - "{% if not bios_iommu_enabled %}    2. AMD boards: AMD CBS → NBIO → IOMMU → Enabled{% endif %}"
      - "{% if not bios_iommu_enabled %}       Intel boards: enable VT-d{% endif %}"
      - "{% if not bios_iommu_enabled %}    3. Save & Exit, then verify: sudo dmesg | grep -i 'AMD-Vi\\|IVRS'{% endif %}"
      - "{% if not bios_iommu_enabled %}{% endif %}"
      - "  After reboot, verify with:"
      - "       sudo dmesg | grep -i iommu"
      - "       lspci -k -s {{ gpu_pci_slot }}"
      - "       (Kernel driver in use should be: vfio-pci)"
      - ""
      - "  Then deploy Windows 11 with GPU:"
      - "    ansible-playbook windows-client-controller.yaml -e action=reinstall -e enable_gpu=true"

- name: Display result summary (no reboot — but BIOS IOMMU missing)
  when:
    - gpu_action | default('setup') == 'setup'
    - not (reboot_required | bool)
    - not bios_iommu_enabled
  ansible.builtin.debug:
    msg:
      - "  Host config is complete, but BIOS IOMMU is NOT enabled."
      - ""
      - "  ⚠ REQUIRED: Enable IOMMU in BIOS firmware:"
      - "    1. Reboot → enter BIOS (Del or F2 at POST)"
      - "    2. AMD boards: AMD CBS → NBIO → IOMMU → Enabled"
      - "       Intel boards: enable VT-d"
      - "    3. Save & Exit → boot into Fedora"
      - ""
      - "  After BIOS change + reboot, verify:"
      - "    sudo dmesg | grep -i 'AMD-Vi\\|IVRS'"
      - "    ls /sys/kernel/iommu_groups/ | wc -l   (should be > 0)"
      - "    lspci -k -s {{ gpu_pci_slot }}          (should show: vfio-pci)"

- name: Display result summary (no reboot needed — all good)
  when:
    - gpu_action | default('setup') == 'setup'
    - not (reboot_required | bool)
    - bios_iommu_enabled
  ansible.builtin.debug:
    msg:
      - "  No reboot required — IOMMU and vfio-pci already active"
      - ""
      - "  Deploy Windows 11 with GPU:"
      - "    ansible-playbook windows-client-controller.yaml -e action=reinstall -e enable_gpu=true"
      - ""
      - "  Or claim GPU now (stops AI workloads, binds vfio-pci, starts VM):"
      - "    ansible-playbook windows-client-controller.yaml -e action=gpu-claim"

# ============================================================
# Phase 7 — Claim GPU for Windows VM (vfio-pci ← nvidia, no reboot)
# ============================================================
- name: GPU claim — switch GPU from nvidia to vfio-pci at runtime
  when: gpu_action | default('setup') == 'claim'
  block:
    - name: Get current GPU VGA driver (claim)
      ansible.builtin.shell: |
        basename $(readlink /sys/bus/pci/devices/{{ gpu_pci_slot }}/driver 2>/dev/null) 2>/dev/null || echo "none"
      register: claim_current_driver
      changed_when: false

    - name: Show state before claim
      ansible.builtin.debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "  GPU CLAIM — nvidia → vfio-pci  (no reboot needed)"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "  GPU VGA   {{ gpu_pci_slot }}  current driver: {{ claim_current_driver.stdout }}"
          - "  GPU Audio {{ gpu_audio_slot }}"
          - "  Plan: stop AI workloads → unload nvidia → bind vfio-pci → start Windows VM"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    - name: Already bound to vfio-pci
      ansible.builtin.debug:
        msg: "GPU already bound to vfio-pci — skipping rebind."
      when: claim_current_driver.stdout == 'vfio-pci'

    - name: Stop AI workloads that hold the GPU (ollama, comfyui, pytorch)
      ansible.builtin.shell:
        cmd: |
          systemctl stop ollama 2>/dev/null && echo "stopped: ollama" || echo "not running: ollama"
          pkill -f comfyui 2>/dev/null && echo "stopped: comfyui" || echo "not running: comfyui"
          pkill -f "python.*torch" 2>/dev/null && echo "stopped: torch processes" || echo "not running: torch"
          sleep 1
      changed_when: false
      ignore_errors: true
      when: claim_current_driver.stdout != 'vfio-pci'

    - name: Unload nvidia kernel modules (dependency order)
      ansible.builtin.shell:
        cmd: |
          for mod in nvidia_uvm nvidia_drm nvidia_modeset nvidia; do
            if lsmod | grep -q "^${mod} "; then
              rmmod "$mod" 2>/dev/null || modprobe -r "$mod" 2>/dev/null || true
              echo "unloaded: $mod"
            fi
          done
          echo "done"
      register: unload_result
      changed_when: true
      when: claim_current_driver.stdout != 'vfio-pci'

    - name: Unbind GPU VGA + Audio from current driver
      ansible.builtin.shell:
        cmd: |
          echo "{{ gpu_pci_slot }}" > /sys/bus/pci/devices/{{ gpu_pci_slot }}/driver/unbind 2>/dev/null || true
          echo "{{ gpu_audio_slot }}" > /sys/bus/pci/devices/{{ gpu_audio_slot }}/driver/unbind 2>/dev/null || true
          sleep 1
          echo "unbound"
      changed_when: true
      when: claim_current_driver.stdout != 'vfio-pci'

    - name: Ensure vfio modules are loaded
      ansible.builtin.shell:
        cmd: |
          modprobe vfio
          modprobe vfio_iommu_type1
          modprobe vfio-pci
          echo "loaded"
      changed_when: true
      when: claim_current_driver.stdout != 'vfio-pci'

    - name: Bind GPU to vfio-pci
      ansible.builtin.shell:
        cmd: |
          # Set driver_override=vfio-pci explicitly (gpu-release may have cleared it)
          # and in fresh sessions where the dracut hook hasn't run yet.
          echo "vfio-pci" > /sys/bus/pci/devices/{{ gpu_pci_slot }}/driver_override
          echo "vfio-pci" > /sys/bus/pci/devices/{{ gpu_audio_slot }}/driver_override
          # Register PCI IDs with vfio-pci (already present after boot → || true is safe)
          echo "{{ gpu_vendor_id_space }}" > /sys/bus/pci/drivers/vfio-pci/new_id 2>/dev/null || true
          echo "{{ gpu_audio_id_space }}" > /sys/bus/pci/drivers/vfio-pci/new_id 2>/dev/null || true
          sleep 1
          echo "{{ gpu_pci_slot }}" > /sys/bus/pci/drivers/vfio-pci/bind 2>&1
          echo "{{ gpu_audio_slot }}" > /sys/bus/pci/drivers/vfio-pci/bind 2>&1
          sleep 1
          drv=$(basename $(readlink /sys/bus/pci/devices/{{ gpu_pci_slot }}/driver 2>/dev/null) 2>/dev/null || echo "none")
          if [ "$drv" = "vfio-pci" ]; then
            echo "GPU driver is now: $drv ✓"
          else
            echo "ERROR: expected vfio-pci, got '$drv'"
            dmesg | grep -i "03:00.0\|vfio" | tail -5
            exit 1
          fi
      register: claim_bind_result
      changed_when: true
      when: claim_current_driver.stdout != 'vfio-pci'

    - name: Start Windows 11 VM
      ansible.builtin.shell:
        cmd: |
          # virtctl start works with both spec.running and runStrategy VMs.
          # Ignore "already running" errors (exit 0 if started, non-zero if already up).
          out=$(virtctl start {{ vm_name | default('win11client') }} \
            -n {{ kubevirt_namespace | default('default') }} 2>&1) && echo "VM start requested" \
            || echo "VM already running or start pending: $out"
      changed_when: true
      ignore_errors: true

    - name: Claim summary
      ansible.builtin.debug:
        msg:
          - "✅ GPU CLAIMED for Windows VM"
          - "   {{ claim_bind_result.stdout | default('already bound to vfio-pci') }}"
          - ""
          - "   Windows VM: {{ vm_name | default('win11client') }} — start requested"
          - "   Connect:  virtctl vnc {{ vm_name | default('win11client') }} -n {{ kubevirt_namespace | default('default') }}"
          - ""
          - "   To release GPU back to Fedora/AI later:"
          - "     ansible-playbook windows-client-controller.yaml -e action=gpu-release"

# ============================================================
# Phase 8 — Release GPU back to Fedora desktop/AI (nvidia ← vfio-pci, no reboot)
# ============================================================
- name: GPU release — switch GPU from vfio-pci back to nvidia at runtime
  when: gpu_action | default('setup') == 'release'
  block:
    - name: Get current GPU VGA driver (release)
      ansible.builtin.shell: |
        basename $(readlink /sys/bus/pci/devices/{{ gpu_pci_slot }}/driver 2>/dev/null) 2>/dev/null || echo "none"
      register: release_current_driver
      changed_when: false

    - name: Show state before release
      ansible.builtin.debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "  GPU RELEASE — vfio-pci → nvidia  (no reboot needed)"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "  GPU VGA   {{ gpu_pci_slot }}  current driver: {{ release_current_driver.stdout }}"
          - "  GPU Audio {{ gpu_audio_slot }}"
          - "  Plan: stop Windows VM → unbind vfio-pci → load nvidia → GPU available to Fedora+CUDA"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    - name: Already bound to nvidia
      ansible.builtin.debug:
        msg: "GPU already bound to nvidia — nothing to do."
      when: release_current_driver.stdout == 'nvidia'

    - name: Stop Windows 11 VM gracefully
      ansible.builtin.shell:
        cmd: |
          out=$(virtctl stop {{ vm_name | default('win11client') }} \
            -n {{ kubevirt_namespace | default('default') }} 2>&1) && echo "stop requested" \
            || echo "VM already stopped or stop pending: $out"
      changed_when: true
      ignore_errors: true
      when: release_current_driver.stdout != 'nvidia'

    - name: Wait for Windows VM to stop (up to 60s)
      ansible.builtin.shell:
        cmd: |
          for i in $(seq 1 12); do
            phase=$(kubectl get vmi {{ vm_name | default('win11client') }} \
              -n {{ kubevirt_namespace | default('default') }} \
              -o jsonpath='{.status.phase}' 2>/dev/null || echo "gone")
            [ "$phase" = "gone" ] || [ -z "$phase" ] && echo "VM stopped" && exit 0
            echo "Waiting for VM stop... phase=$phase ($i/12)"
            sleep 5
          done
          echo "timeout — proceeding with unbind anyway"
      register: vm_stop_wait
      changed_when: false
      ignore_errors: true
      when: release_current_driver.stdout != 'nvidia'

    - name: Unbind GPU from vfio-pci and clear driver_override
      ansible.builtin.shell:
        cmd: |
          echo "{{ gpu_pci_slot }}" > /sys/bus/pci/drivers/vfio-pci/unbind 2>/dev/null || true
          echo "{{ gpu_audio_slot }}" > /sys/bus/pci/drivers/vfio-pci/unbind 2>/dev/null || true
          echo "{{ gpu_vendor_id_space }}" > /sys/bus/pci/drivers/vfio-pci/remove_id 2>/dev/null || true
          echo "{{ gpu_audio_id_space }}" > /sys/bus/pci/drivers/vfio-pci/remove_id 2>/dev/null || true
          # CRITICAL: clear driver_override so nvidia can claim the device
          # The dracut hook sets driver_override=vfio-pci at boot; without clearing
          # it, nvidia bind silently fails (echoes to the file but device rejects bind)
          echo "" > /sys/bus/pci/devices/{{ gpu_pci_slot }}/driver_override 2>/dev/null || true
          echo "" > /sys/bus/pci/devices/{{ gpu_audio_slot }}/driver_override 2>/dev/null || true
          sleep 1
          echo "unbound from vfio-pci, driver_override cleared"
      changed_when: true
      when: release_current_driver.stdout != 'nvidia'

    - name: Reset GPU via parent bridge SBR to clear dirty QEMU hardware state
      # After QEMU releases a vfio-pci device, the GPU is left in a dirty state:
      # NVIDIA GSP firmware did not shut down cleanly, so nvidia driver init fails
      # with 'kgspWaitForGfwBootOk_TU102: failed to wait for GFW boot complete'.
      # Solution: trigger Secondary Bus Reset (SBR) via the parent PCIe bridge,
      # which performs a full hardware reset of everything on that bus.
      # Parent bridge is computed dynamically from the GPU sysfs symlink.
      ansible.builtin.shell:
        cmd: |
          GPU="{{ gpu_pci_slot }}"
          PARENT=$(basename $(dirname $(readlink /sys/bus/pci/devices/$GPU 2>/dev/null)) 2>/dev/null)
          echo "GPU parent bridge: $PARENT"
          if [ -f "/sys/bus/pci/devices/$PARENT/reset" ]; then
            echo "Triggering Secondary Bus Reset (SBR) on $PARENT"
            echo 1 > /sys/bus/pci/devices/$PARENT/reset
            sleep 2
            echo "SBR complete — GPU hardware state cleared"
          elif [ -f "/sys/bus/pci/devices/$GPU/reset" ]; then
            echo "No parent bridge reset, falling back to FLR on $GPU"
            echo 1 > /sys/bus/pci/devices/$GPU/reset
            sleep 1
            echo "FLR complete"
          else
            echo "WARNING: No reset method available — nvidia GSP init may fail"
          fi
      register: gpu_sbr_result
      changed_when: true
      when: release_current_driver.stdout != 'nvidia'

    - name: Load nvidia driver and rebind GPU
      ansible.builtin.shell:
        cmd: |
          modprobe nvidia 2>/dev/null || true
          modprobe nvidia_modeset 2>/dev/null || true
          modprobe nvidia_uvm 2>/dev/null || true
          modprobe nvidia_drm modeset=1 2>/dev/null || true
          sleep 1
          echo "{{ gpu_pci_slot }}" > /sys/bus/pci/drivers/nvidia/bind 2>&1
          sleep 3
          drv=$(basename $(readlink /sys/bus/pci/devices/{{ gpu_pci_slot }}/driver 2>/dev/null) 2>/dev/null || echo "none")
          if [ "$drv" = "nvidia" ]; then
            echo "GPU driver is now: $drv ✓"
          else
            echo "ERROR: expected nvidia, got '$drv'"
            dmesg | grep -i "03:00.0\|kgsp\|RmInitAdapter" | tail -5
            exit 1
          fi
      register: nvidia_bind_result
      changed_when: true
      when: release_current_driver.stdout != 'nvidia'

    - name: Restart display manager so Fedora desktop picks up the GPU
      ansible.builtin.shell:
        cmd: |
          systemctl restart gdm 2>/dev/null && echo "restarted: gdm" || \
          systemctl restart sddm 2>/dev/null && echo "restarted: sddm" || \
          systemctl restart lightdm 2>/dev/null && echo "restarted: lightdm" || \
          echo "no display manager restarted"
      changed_when: false
      ignore_errors: true
      when: release_current_driver.stdout != 'nvidia'

    - name: Release summary
      ansible.builtin.debug:
        msg:
          - "✅ GPU RELEASED to Fedora / CUDA"
          - "   Reset: {{ gpu_sbr_result.stdout_lines | default(['skipped']) | join(' | ') }}"
          - "   Bind:  {{ nvidia_bind_result.stdout | default('already bound to nvidia') }}"
          - ""
          - "   Verify GPU is back:"
          - "     nvidia-smi"
          - "     python -c 'import torch; print(torch.cuda.is_available())'"
          - ""
          - "   Start AI workloads:"
          - "     ollama serve"
          - "     # ComfyUI, Stable Diffusion, any CUDA workload"
          - ""
          - "   To reclaim for Windows VM later:"
          - "     ansible-playbook windows-client-controller.yaml -e action=gpu-claim"

